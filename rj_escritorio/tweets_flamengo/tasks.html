<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>pipelines.rj_escritorio.tweets_flamengo.tasks API documentation</title>
<meta name="description" content="Tasks for twitter scraping." />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>pipelines.rj_escritorio.tweets_flamengo.tasks</code></h1>
</header>
<section id="section-intro">
<p>Tasks for twitter scraping.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># -*- coding: utf-8 -*-
&#34;&#34;&#34;
Tasks for twitter scraping.
&#34;&#34;&#34;

###############################################################################
#
# Aqui é onde devem ser definidas as tasks para os flows do projeto.
# Cada task representa um passo da pipeline. Não é estritamente necessário
# tratar todas as exceções que podem ocorrer durante a execução de uma task,
# mas é recomendável, ainda que não vá implicar em  uma quebra no sistema.
# Mais informações sobre tasks podem ser encontradas na documentação do
# Prefect: https://docs.prefect.io/core/concepts/tasks.html
#
# De modo a manter consistência na codebase, todo o código escrito passará
# pelo pylint. Todos os warnings e erros devem ser corrigidos.
#
# As tasks devem ser definidas como funções comuns ao Python, com o decorador
# @task acima. É recomendado inserir type hints para as variáveis.
#
# Um exemplo de task é o seguinte:
#
# -----------------------------------------------------------------------------
# from prefect import task
#
# @task
# def my_task(param1: str, param2: int) -&gt; str:
#     &#34;&#34;&#34;
#     My task description.
#     &#34;&#34;&#34;
#     return f&#39;{param1} {param2}&#39;
# -----------------------------------------------------------------------------
#
# Você também pode usar pacotes Python arbitrários, como numpy, pandas, etc.
#
# -----------------------------------------------------------------------------
# from prefect import task
# import numpy as np
#
# @task
# def my_task(a: np.ndarray, b: np.ndarray) -&gt; str:
#     &#34;&#34;&#34;
#     My task description.
#     &#34;&#34;&#34;
#     return np.add(a, b)
# -----------------------------------------------------------------------------
#
# Abaixo segue um código para exemplificação, que pode ser removido.
#
###############################################################################
import base64
import os
import time
import json
from datetime import datetime

import shutil
import pandas as pd
import numpy as np
import basedosdados as bd
import tweepy

from prefect import task

from pipelines.utils.utils import log


def decode_env(value: str):
    &#34;&#34;&#34;
    Decodes a base64 value.
    &#34;&#34;&#34;
    return base64.b64decode(value).decode()


@task
def get_api():
    &#34;&#34;&#34;
    Get the Twitter API.
    &#34;&#34;&#34;

    # pylint: disable=C0103
    CREDENTIALS = json.loads(decode_env(os.getenv(&#34;TWITTER_CREDENTIALS&#34;)))

    auth = tweepy.OAuthHandler(
        CREDENTIALS[&#34;CONSUMER_KEY&#34;], CREDENTIALS[&#34;CONSUMER_SECRET&#34;]
    )
    auth.set_access_token(
        CREDENTIALS[&#34;ACCESS_TOKEN&#34;], CREDENTIALS[&#34;ACCESS_TOKEN_SECRET&#34;]
    )
    return tweepy.API(auth)


def normalize_cols(df):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Normalize columns names.
    &#34;&#34;&#34;
    return (
        df.str.normalize(&#34;NFKD&#34;)
        .str.encode(&#34;ascii&#34;, errors=&#34;ignore&#34;)
        .str.decode(&#34;utf-8&#34;)
        .str.replace(&#34;$&#34;, &#34;&#34;)
        .str.replace(&#34;(&#34;, &#34;&#34;)
        .str.replace(&#34;)&#34;, &#34;&#34;)
        .str.replace(&#34;-&#34;, &#34;&#34;)
        .str.replace(&#34; &#34;, &#34;_&#34;)
        .str.lower()
        .str.replace(&#34;.&#34;, &#34;&#34;)
        .str.replace(&#34;/&#34;, &#34;_&#34;)
    )


def creat_path_tree(path):
    &#34;&#34;&#34;
    Creates a path tree.
    &#34;&#34;&#34;
    current_path = &#34;&#34;
    for folder in path.split(&#34;/&#34;):
        current_path += f&#34;{folder}/&#34;
        if folder != &#34;..&#34; and not os.path.isdir(current_path):
            os.mkdir(current_path)


@task
def save_last_id(df, q):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Save the last tweet ID.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    pre_path = f&#34;data/staging/twitter_flamengo/last_id/q={q_folder}&#34;
    creat_path_tree(pre_path)

    if not os.path.exists(f&#34;{pre_path}/{q_folder}.csv&#34;):
        pd.DataFrame({&#34;q&#34;: [], &#34;id&#34;: [], &#34;created_at&#34;: []}).to_csv(
            f&#34;{pre_path}/{q_folder}.csv&#34;, index=False
        )

    if df is None:
        log(&#34;   No new tweets found&#34;)
    else:
        # twitter fetch data from most recent to most oldest
        # last_id must to be the most recent id
        df = df[[&#34;id&#34;, &#34;created_at&#34;]].iloc[[0]].copy()
        df.to_csv(f&#34;{pre_path}/{q_folder}.csv&#34;, index=False, mode=&#34;a&#34;, header=False)
    return &#34;data/staging&#34;


@task
def fetch_last_id(q):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Download last_id table from storage.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    # pylint: disable=C0103
    st = bd.Storage(
        dataset_id=&#34;twitter_flamengo&#34;,
        table_id=&#34;last_id&#34;,
    )
    try:
        st.download(
            filename=f&#34;{q_folder}.csv&#34;,
            savepath=&#34;data&#34;,
            partitions=f&#34;q={q_folder}/&#34;,
            mode=&#34;staging&#34;,
            if_not_exists=&#34;raise&#34;,
        )

        pre_path = f&#34;data/staging/twitter_flamengo/last_id/q={q_folder}&#34;
        df = pd.read_csv(f&#34;{pre_path}/{q_folder}.csv&#34;)  # pylint: disable=C0103
        if &#34;q&#34; in df.columns.tolist():
            df.columns = [&#34;id&#34;, &#34;created_at&#34;, &#34;q&#34;]
            df.drop(&#34;q&#34;, 1).to_csv(  # pylint: disable=E1101
                f&#34;{pre_path}/{q_folder}.csv&#34;, index=False
            )
    except FileNotFoundError:
        log(f&#34;No table {q_folder} in storage&#34;)

    return &#34;data/staging&#34;


@task(nout=2)
def get_last_id(api, q, data_path: str):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Get last_id from storage table or twitter api.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    pre_path = f&#34;{data_path}/twitter_flamengo/last_id/q={q_folder}&#34;
    if not os.path.exists(f&#34;{pre_path}/{q_folder}.csv&#34;):
        log(f&#34;No last_id table found for {q}, fetch last_id from Twitter API&#34;)
        tweet = api.search_tweets(q=q, count=1)[0]
        last_id = tweet.id
        created_at = tweet.created_at
        time.sleep(5)
    else:
        df = pd.read_csv(f&#34;{pre_path}/{q_folder}.csv&#34;).copy()  # pylint: disable=C0103
        if len(df) &gt; 0:
            log(f&#34;Getting last_id from storage table {q_folder}&#34;)
            last_id = int(df[[&#34;id&#34;]].iloc[-1])
            created_at = df[[&#34;created_at&#34;]].iloc[-1].values[0]
        else:
            log(f&#34;No last_id saved in table for {q}, fetch last_id from Twitter API&#34;)
            tweet = api.search_tweets(q=q, count=1)[0]
            last_id = tweet.id
            created_at = tweet.created_at
            time.sleep(5)
    return last_id, created_at


@task
def fetch_tweets(api, q, last_id, created_at):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Scrapy tweets since last_id in batchs of 100 tweets.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    dt = datetime.today().strftime(&#34;%Y-%m-%d-%H-%M-%S&#34;)  # pylint: disable=C0103
    first_page_df = None
    log(f&#34;{q} | last_id: {last_id} | created_at: {created_at} | file: {dt}&#34;)

    for i, page in enumerate(
        tweepy.Cursor(api.search_tweets, q=q, since_id=last_id, count=100).pages(100),
        start=1,
    ):
        json_data = [t._json for t in page]  # pylint: disable=W0212
        dd = pd.json_normalize(json_data)  # pylint: disable=C0103
        dd.columns = normalize_cols(dd.columns)

        cols_343 = [
            &#34;created_at&#34;,
            &#34;id&#34;,
            &#34;id_str&#34;,
            &#34;text&#34;,
            &#34;truncated&#34;,
            &#34;source&#34;,
            &#34;in_reply_to_status_id&#34;,
            &#34;in_reply_to_status_id_str&#34;,
            &#34;in_reply_to_user_id&#34;,
            &#34;in_reply_to_user_id_str&#34;,
            &#34;in_reply_to_screen_name&#34;,
            &#34;geo&#34;,
            &#34;coordinates&#34;,
            &#34;place&#34;,
            &#34;contributors&#34;,
            &#34;is_quote_status&#34;,
            &#34;retweet_count&#34;,
            &#34;favorite_count&#34;,
            &#34;favorited&#34;,
            &#34;retweeted&#34;,
            &#34;lang&#34;,
            &#34;entitieshashtags&#34;,
            &#34;entitiessymbols&#34;,
            &#34;entitiesuser_mentions&#34;,
            &#34;entitiesurls&#34;,
            &#34;metadataiso_language_code&#34;,
            &#34;metadataresult_type&#34;,
            &#34;userid&#34;,
            &#34;userid_str&#34;,
            &#34;username&#34;,
            &#34;userscreen_name&#34;,
            &#34;userlocation&#34;,
            &#34;userdescription&#34;,
            &#34;userurl&#34;,
            &#34;userentitiesurlurls&#34;,
            &#34;userentitiesdescriptionurls&#34;,
            &#34;userprotected&#34;,
            &#34;userfollowers_count&#34;,
            &#34;userfriends_count&#34;,
            &#34;userlisted_count&#34;,
            &#34;usercreated_at&#34;,
            &#34;userfavourites_count&#34;,
            &#34;userutc_offset&#34;,
            &#34;usertime_zone&#34;,
            &#34;usergeo_enabled&#34;,
            &#34;userverified&#34;,
            &#34;userstatuses_count&#34;,
            &#34;userlang&#34;,
            &#34;usercontributors_enabled&#34;,
            &#34;useris_translator&#34;,
            &#34;useris_translation_enabled&#34;,
            &#34;userprofile_background_color&#34;,
            &#34;userprofile_background_image_url&#34;,
            &#34;userprofile_background_image_url_https&#34;,
            &#34;userprofile_background_tile&#34;,
            &#34;userprofile_image_url&#34;,
            &#34;userprofile_image_url_https&#34;,
            &#34;userprofile_banner_url&#34;,
            &#34;userprofile_link_color&#34;,
            &#34;userprofile_sidebar_border_color&#34;,
            &#34;userprofile_sidebar_fill_color&#34;,
            &#34;userprofile_text_color&#34;,
            &#34;userprofile_use_background_image&#34;,
            &#34;userhas_extended_profile&#34;,
            &#34;userdefault_profile&#34;,
            &#34;userdefault_profile_image&#34;,
            &#34;userfollowing&#34;,
            &#34;userfollow_request_sent&#34;,
            &#34;usernotifications&#34;,
            &#34;usertranslator_type&#34;,
            &#34;userwithheld_in_countries&#34;,
            &#34;retweeted_statuscreated_at&#34;,
            &#34;retweeted_statusid&#34;,
            &#34;retweeted_statusid_str&#34;,
            &#34;retweeted_statustext&#34;,
            &#34;retweeted_statustruncated&#34;,
            &#34;retweeted_statusentitieshashtags&#34;,
            &#34;retweeted_statusentitiessymbols&#34;,
            &#34;retweeted_statusentitiesuser_mentions&#34;,
            &#34;retweeted_statusentitiesurls&#34;,
            &#34;retweeted_statusmetadataiso_language_code&#34;,
            &#34;retweeted_statusmetadataresult_type&#34;,
            &#34;retweeted_statussource&#34;,
            &#34;retweeted_statusin_reply_to_status_id&#34;,
            &#34;retweeted_statusin_reply_to_status_id_str&#34;,
            &#34;retweeted_statusin_reply_to_user_id&#34;,
            &#34;retweeted_statusin_reply_to_user_id_str&#34;,
            &#34;retweeted_statusin_reply_to_screen_name&#34;,
            &#34;retweeted_statususerid&#34;,
            &#34;retweeted_statususerid_str&#34;,
            &#34;retweeted_statususername&#34;,
            &#34;retweeted_statususerscreen_name&#34;,
            &#34;retweeted_statususerlocation&#34;,
            &#34;retweeted_statususerdescription&#34;,
            &#34;retweeted_statususerurl&#34;,
            &#34;retweeted_statususerentitiesdescriptionurls&#34;,
            &#34;retweeted_statususerprotected&#34;,
            &#34;retweeted_statususerfollowers_count&#34;,
            &#34;retweeted_statususerfriends_count&#34;,
            &#34;retweeted_statususerlisted_count&#34;,
            &#34;retweeted_statususercreated_at&#34;,
            &#34;retweeted_statususerfavourites_count&#34;,
            &#34;retweeted_statususerutc_offset&#34;,
            &#34;retweeted_statususertime_zone&#34;,
            &#34;retweeted_statususergeo_enabled&#34;,
            &#34;retweeted_statususerverified&#34;,
            &#34;retweeted_statususerstatuses_count&#34;,
            &#34;retweeted_statususerlang&#34;,
            &#34;retweeted_statususercontributors_enabled&#34;,
            &#34;retweeted_statususeris_translator&#34;,
            &#34;retweeted_statususeris_translation_enabled&#34;,
            &#34;retweeted_statususerprofile_background_color&#34;,
            &#34;retweeted_statususerprofile_background_image_url&#34;,
            &#34;retweeted_statususerprofile_background_image_url_https&#34;,
            &#34;retweeted_statususerprofile_background_tile&#34;,
            &#34;retweeted_statususerprofile_image_url&#34;,
            &#34;retweeted_statususerprofile_image_url_https&#34;,
            &#34;retweeted_statususerprofile_banner_url&#34;,
            &#34;retweeted_statususerprofile_link_color&#34;,
            &#34;retweeted_statususerprofile_sidebar_border_color&#34;,
            &#34;retweeted_statususerprofile_sidebar_fill_color&#34;,
            &#34;retweeted_statususerprofile_text_color&#34;,
            &#34;retweeted_statususerprofile_use_background_image&#34;,
            &#34;retweeted_statususerhas_extended_profile&#34;,
            &#34;retweeted_statususerdefault_profile&#34;,
            &#34;retweeted_statususerdefault_profile_image&#34;,
            &#34;retweeted_statususerfollowing&#34;,
            &#34;retweeted_statususerfollow_request_sent&#34;,
            &#34;retweeted_statususernotifications&#34;,
            &#34;retweeted_statususertranslator_type&#34;,
            &#34;retweeted_statususerwithheld_in_countries&#34;,
            &#34;retweeted_statusgeo&#34;,
            &#34;retweeted_statuscoordinates&#34;,
            &#34;retweeted_statusplace&#34;,
            &#34;retweeted_statuscontributors&#34;,
            &#34;retweeted_statusis_quote_status&#34;,
            &#34;retweeted_statusretweet_count&#34;,
            &#34;retweeted_statusfavorite_count&#34;,
            &#34;retweeted_statusfavorited&#34;,
            &#34;retweeted_statusretweeted&#34;,
            &#34;retweeted_statuslang&#34;,
            &#34;possibly_sensitive&#34;,
            &#34;entitiesmedia&#34;,
            &#34;extended_entitiesmedia&#34;,
            &#34;retweeted_statusentitiesmedia&#34;,
            &#34;retweeted_statusextended_entitiesmedia&#34;,
            &#34;retweeted_statususerentitiesurlurls&#34;,
            &#34;retweeted_statuspossibly_sensitive&#34;,
            &#34;placeid&#34;,
            &#34;placeurl&#34;,
            &#34;placeplace_type&#34;,
            &#34;placename&#34;,
            &#34;placefull_name&#34;,
            &#34;placecountry_code&#34;,
            &#34;placecountry&#34;,
            &#34;placecontained_within&#34;,
            &#34;placebounding_boxtype&#34;,
            &#34;placebounding_boxcoordinates&#34;,
            &#34;quoted_status_id&#34;,
            &#34;quoted_status_id_str&#34;,
            &#34;quoted_statuscreated_at&#34;,
            &#34;quoted_statusid&#34;,
            &#34;quoted_statusid_str&#34;,
            &#34;quoted_statustext&#34;,
            &#34;quoted_statustruncated&#34;,
            &#34;quoted_statusentitieshashtags&#34;,
            &#34;quoted_statusentitiessymbols&#34;,
            &#34;quoted_statusentitiesuser_mentions&#34;,
            &#34;quoted_statusentitiesurls&#34;,
            &#34;quoted_statusentitiesmedia&#34;,
            &#34;quoted_statusextended_entitiesmedia&#34;,
            &#34;quoted_statusmetadataiso_language_code&#34;,
            &#34;quoted_statusmetadataresult_type&#34;,
            &#34;quoted_statussource&#34;,
            &#34;quoted_statusin_reply_to_status_id&#34;,
            &#34;quoted_statusin_reply_to_status_id_str&#34;,
            &#34;quoted_statusin_reply_to_user_id&#34;,
            &#34;quoted_statusin_reply_to_user_id_str&#34;,
            &#34;quoted_statusin_reply_to_screen_name&#34;,
            &#34;quoted_statususerid&#34;,
            &#34;quoted_statususerid_str&#34;,
            &#34;quoted_statususername&#34;,
            &#34;quoted_statususerscreen_name&#34;,
            &#34;quoted_statususerlocation&#34;,
            &#34;quoted_statususerdescription&#34;,
            &#34;quoted_statususerurl&#34;,
            &#34;quoted_statususerentitiesurlurls&#34;,
            &#34;quoted_statususerentitiesdescriptionurls&#34;,
            &#34;quoted_statususerprotected&#34;,
            &#34;quoted_statususerfollowers_count&#34;,
            &#34;quoted_statususerfriends_count&#34;,
            &#34;quoted_statususerlisted_count&#34;,
            &#34;quoted_statususercreated_at&#34;,
            &#34;quoted_statususerfavourites_count&#34;,
            &#34;quoted_statususerutc_offset&#34;,
            &#34;quoted_statususertime_zone&#34;,
            &#34;quoted_statususergeo_enabled&#34;,
            &#34;quoted_statususerverified&#34;,
            &#34;quoted_statususerstatuses_count&#34;,
            &#34;quoted_statususerlang&#34;,
            &#34;quoted_statususercontributors_enabled&#34;,
            &#34;quoted_statususeris_translator&#34;,
            &#34;quoted_statususeris_translation_enabled&#34;,
            &#34;quoted_statususerprofile_background_color&#34;,
            &#34;quoted_statususerprofile_background_image_url&#34;,
            &#34;quoted_statususerprofile_background_image_url_https&#34;,
            &#34;quoted_statususerprofile_background_tile&#34;,
            &#34;quoted_statususerprofile_image_url&#34;,
            &#34;quoted_statususerprofile_image_url_https&#34;,
            &#34;quoted_statususerprofile_banner_url&#34;,
            &#34;quoted_statususerprofile_link_color&#34;,
            &#34;quoted_statususerprofile_sidebar_border_color&#34;,
            &#34;quoted_statususerprofile_sidebar_fill_color&#34;,
            &#34;quoted_statususerprofile_text_color&#34;,
            &#34;quoted_statususerprofile_use_background_image&#34;,
            &#34;quoted_statususerhas_extended_profile&#34;,
            &#34;quoted_statususerdefault_profile&#34;,
            &#34;quoted_statususerdefault_profile_image&#34;,
            &#34;quoted_statususerfollowing&#34;,
            &#34;quoted_statususerfollow_request_sent&#34;,
            &#34;quoted_statususernotifications&#34;,
            &#34;quoted_statususertranslator_type&#34;,
            &#34;quoted_statususerwithheld_in_countries&#34;,
            &#34;quoted_statusgeo&#34;,
            &#34;quoted_statuscoordinates&#34;,
            &#34;quoted_statusplaceid&#34;,
            &#34;quoted_statusplaceurl&#34;,
            &#34;quoted_statusplaceplace_type&#34;,
            &#34;quoted_statusplacename&#34;,
            &#34;quoted_statusplacefull_name&#34;,
            &#34;quoted_statusplacecountry_code&#34;,
            &#34;quoted_statusplacecountry&#34;,
            &#34;quoted_statusplacecontained_within&#34;,
            &#34;quoted_statusplacebounding_boxtype&#34;,
            &#34;quoted_statusplacebounding_boxcoordinates&#34;,
            &#34;quoted_statuscontributors&#34;,
            &#34;quoted_statusis_quote_status&#34;,
            &#34;quoted_statusretweet_count&#34;,
            &#34;quoted_statusfavorite_count&#34;,
            &#34;quoted_statusfavorited&#34;,
            &#34;quoted_statusretweeted&#34;,
            &#34;quoted_statuspossibly_sensitive&#34;,
            &#34;quoted_statuslang&#34;,
            &#34;retweeted_statusplaceid&#34;,
            &#34;retweeted_statusplaceurl&#34;,
            &#34;retweeted_statusplaceplace_type&#34;,
            &#34;retweeted_statusplacename&#34;,
            &#34;retweeted_statusplacefull_name&#34;,
            &#34;retweeted_statusplacecountry_code&#34;,
            &#34;retweeted_statusplacecountry&#34;,
            &#34;retweeted_statusplacecontained_within&#34;,
            &#34;retweeted_statusplacebounding_boxtype&#34;,
            &#34;retweeted_statusplacebounding_boxcoordinates&#34;,
            &#34;retweeted_statusquoted_status_id&#34;,
            &#34;retweeted_statusquoted_status_id_str&#34;,
            &#34;retweeted_statusquoted_statuscreated_at&#34;,
            &#34;retweeted_statusquoted_statusid&#34;,
            &#34;retweeted_statusquoted_statusid_str&#34;,
            &#34;retweeted_statusquoted_statustext&#34;,
            &#34;retweeted_statusquoted_statustruncated&#34;,
            &#34;retweeted_statusquoted_statusentitieshashtags&#34;,
            &#34;retweeted_statusquoted_statusentitiessymbols&#34;,
            &#34;retweeted_statusquoted_statusentitiesuser_mentions&#34;,
            &#34;retweeted_statusquoted_statusentitiesurls&#34;,
            &#34;retweeted_statusquoted_statusentitiesmedia&#34;,
            &#34;retweeted_statusquoted_statusextended_entitiesmedia&#34;,
            &#34;retweeted_statusquoted_statusmetadataiso_language_code&#34;,
            &#34;retweeted_statusquoted_statusmetadataresult_type&#34;,
            &#34;retweeted_statusquoted_statussource&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_status_id&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_status_id_str&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_user_id&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_user_id_str&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_screen_name&#34;,
            &#34;retweeted_statusquoted_statususerid&#34;,
            &#34;retweeted_statusquoted_statususerid_str&#34;,
            &#34;retweeted_statusquoted_statususername&#34;,
            &#34;retweeted_statusquoted_statususerscreen_name&#34;,
            &#34;retweeted_statusquoted_statususerlocation&#34;,
            &#34;retweeted_statusquoted_statususerdescription&#34;,
            &#34;retweeted_statusquoted_statususerurl&#34;,
            &#34;retweeted_statusquoted_statususerentitiesurlurls&#34;,
            &#34;retweeted_statusquoted_statususerentitiesdescriptionurls&#34;,
            &#34;retweeted_statusquoted_statususerprotected&#34;,
            &#34;retweeted_statusquoted_statususerfollowers_count&#34;,
            &#34;retweeted_statusquoted_statususerfriends_count&#34;,
            &#34;retweeted_statusquoted_statususerlisted_count&#34;,
            &#34;retweeted_statusquoted_statususercreated_at&#34;,
            &#34;retweeted_statusquoted_statususerfavourites_count&#34;,
            &#34;retweeted_statusquoted_statususerutc_offset&#34;,
            &#34;retweeted_statusquoted_statususertime_zone&#34;,
            &#34;retweeted_statusquoted_statususergeo_enabled&#34;,
            &#34;retweeted_statusquoted_statususerverified&#34;,
            &#34;retweeted_statusquoted_statususerstatuses_count&#34;,
            &#34;retweeted_statusquoted_statususerlang&#34;,
            &#34;retweeted_statusquoted_statususercontributors_enabled&#34;,
            &#34;retweeted_statusquoted_statususeris_translator&#34;,
            &#34;retweeted_statusquoted_statususeris_translation_enabled&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_image_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_image_url_https&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_tile&#34;,
            &#34;retweeted_statusquoted_statususerprofile_image_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_image_url_https&#34;,
            &#34;retweeted_statusquoted_statususerprofile_banner_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_link_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_sidebar_border_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_sidebar_fill_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_text_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_use_background_image&#34;,
            &#34;retweeted_statusquoted_statususerhas_extended_profile&#34;,
            &#34;retweeted_statusquoted_statususerdefault_profile&#34;,
            &#34;retweeted_statusquoted_statususerdefault_profile_image&#34;,
            &#34;retweeted_statusquoted_statususerfollowing&#34;,
            &#34;retweeted_statusquoted_statususerfollow_request_sent&#34;,
            &#34;retweeted_statusquoted_statususernotifications&#34;,
            &#34;retweeted_statusquoted_statususertranslator_type&#34;,
            &#34;retweeted_statusquoted_statususerwithheld_in_countries&#34;,
            &#34;retweeted_statusquoted_statusgeo&#34;,
            &#34;retweeted_statusquoted_statuscoordinates&#34;,
            &#34;retweeted_statusquoted_statusplaceid&#34;,
            &#34;retweeted_statusquoted_statusplaceurl&#34;,
            &#34;retweeted_statusquoted_statusplaceplace_type&#34;,
            &#34;retweeted_statusquoted_statusplacename&#34;,
            &#34;retweeted_statusquoted_statusplacefull_name&#34;,
            &#34;retweeted_statusquoted_statusplacecountry_code&#34;,
            &#34;retweeted_statusquoted_statusplacecountry&#34;,
            &#34;retweeted_statusquoted_statusplacecontained_within&#34;,
            &#34;retweeted_statusquoted_statusplacebounding_boxtype&#34;,
            &#34;retweeted_statusquoted_statusplacebounding_boxcoordinates&#34;,
            &#34;retweeted_statusquoted_statuscontributors&#34;,
            &#34;retweeted_statusquoted_statusis_quote_status&#34;,
            &#34;retweeted_statusquoted_statusretweet_count&#34;,
            &#34;retweeted_statusquoted_statusfavorite_count&#34;,
            &#34;retweeted_statusquoted_statusfavorited&#34;,
            &#34;retweeted_statusquoted_statusretweeted&#34;,
            &#34;retweeted_statusquoted_statuspossibly_sensitive&#34;,
            &#34;retweeted_statusquoted_statuslang&#34;,
            &#34;quoted_statusplace&#34;,
            &#34;geotype&#34;,
            &#34;geocoordinates&#34;,
            &#34;coordinatestype&#34;,
            &#34;coordinatescoordinates&#34;,
        ]
        col_not_in_dd = [col for col in cols_343 if col not in dd.columns.tolist()]
        for col in col_not_in_dd:
            dd[col] = np.nan
        dd = dd[cols_343]  # pylint: disable=C0103

        creat_path_tree(f&#34;data/tweets/q={q_folder}&#34;)
        if os.path.exists(f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;):
            dd.to_csv(
                f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;,
                index=False,
                mode=&#34;a&#34;,
                header=False,
            )
        else:
            dd.to_csv(f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;, index=False)
            # twitter fetch data from most recent to most oldest
            # the first tweet from first page is the most recent, how its what we call last_id
            first_page_df = dd.copy()

        log(f&#34;    page: {i} | tweets: {len(dd)} | columns: {len(dd.columns)}&#34;)

    return first_page_df


@task
def upload_to_storage(path: str):
    &#34;&#34;&#34;
    upload data to storage
    &#34;&#34;&#34;
    tb_last_id = bd.Table(dataset_id=&#34;twitter_flamengo&#34;, table_id=&#34;last_id&#34;)
    tb_last_id.append(f&#34;{path}/twitter_flamengo/last_id&#34;)
    if os.path.isdir(f&#34;{path}/&#34;):
        shutil.rmtree(f&#34;{path}/&#34;)

    tb_tweet = bd.Table(dataset_id=&#34;twitter_flamengo&#34;, table_id=&#34;tweets&#34;)
    tb_tweet.append(
        &#34;data/tweets&#34;,
    )
    if os.path.isdir(&#34;data/tweets/&#34;):
        shutil.rmtree(&#34;data/tweets/&#34;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.creat_path_tree"><code class="name flex">
<span>def <span class="ident">creat_path_tree</span></span>(<span>path)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a path tree.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def creat_path_tree(path):
    &#34;&#34;&#34;
    Creates a path tree.
    &#34;&#34;&#34;
    current_path = &#34;&#34;
    for folder in path.split(&#34;/&#34;):
        current_path += f&#34;{folder}/&#34;
        if folder != &#34;..&#34; and not os.path.isdir(current_path):
            os.mkdir(current_path)</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.decode_env"><code class="name flex">
<span>def <span class="ident">decode_env</span></span>(<span>value: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Decodes a base64 value.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def decode_env(value: str):
    &#34;&#34;&#34;
    Decodes a base64 value.
    &#34;&#34;&#34;
    return base64.b64decode(value).decode()</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_last_id"><code class="name flex">
<span>def <span class="ident">fetch_last_id</span></span>(<span>q)</span>
</code></dt>
<dd>
<div class="desc"><p>Download last_id table from storage.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task
def fetch_last_id(q):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Download last_id table from storage.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    # pylint: disable=C0103
    st = bd.Storage(
        dataset_id=&#34;twitter_flamengo&#34;,
        table_id=&#34;last_id&#34;,
    )
    try:
        st.download(
            filename=f&#34;{q_folder}.csv&#34;,
            savepath=&#34;data&#34;,
            partitions=f&#34;q={q_folder}/&#34;,
            mode=&#34;staging&#34;,
            if_not_exists=&#34;raise&#34;,
        )

        pre_path = f&#34;data/staging/twitter_flamengo/last_id/q={q_folder}&#34;
        df = pd.read_csv(f&#34;{pre_path}/{q_folder}.csv&#34;)  # pylint: disable=C0103
        if &#34;q&#34; in df.columns.tolist():
            df.columns = [&#34;id&#34;, &#34;created_at&#34;, &#34;q&#34;]
            df.drop(&#34;q&#34;, 1).to_csv(  # pylint: disable=E1101
                f&#34;{pre_path}/{q_folder}.csv&#34;, index=False
            )
    except FileNotFoundError:
        log(f&#34;No table {q_folder} in storage&#34;)

    return &#34;data/staging&#34;</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_tweets"><code class="name flex">
<span>def <span class="ident">fetch_tweets</span></span>(<span>api, q, last_id, created_at)</span>
</code></dt>
<dd>
<div class="desc"><p>Scrapy tweets since last_id in batchs of 100 tweets.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task
def fetch_tweets(api, q, last_id, created_at):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Scrapy tweets since last_id in batchs of 100 tweets.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    dt = datetime.today().strftime(&#34;%Y-%m-%d-%H-%M-%S&#34;)  # pylint: disable=C0103
    first_page_df = None
    log(f&#34;{q} | last_id: {last_id} | created_at: {created_at} | file: {dt}&#34;)

    for i, page in enumerate(
        tweepy.Cursor(api.search_tweets, q=q, since_id=last_id, count=100).pages(100),
        start=1,
    ):
        json_data = [t._json for t in page]  # pylint: disable=W0212
        dd = pd.json_normalize(json_data)  # pylint: disable=C0103
        dd.columns = normalize_cols(dd.columns)

        cols_343 = [
            &#34;created_at&#34;,
            &#34;id&#34;,
            &#34;id_str&#34;,
            &#34;text&#34;,
            &#34;truncated&#34;,
            &#34;source&#34;,
            &#34;in_reply_to_status_id&#34;,
            &#34;in_reply_to_status_id_str&#34;,
            &#34;in_reply_to_user_id&#34;,
            &#34;in_reply_to_user_id_str&#34;,
            &#34;in_reply_to_screen_name&#34;,
            &#34;geo&#34;,
            &#34;coordinates&#34;,
            &#34;place&#34;,
            &#34;contributors&#34;,
            &#34;is_quote_status&#34;,
            &#34;retweet_count&#34;,
            &#34;favorite_count&#34;,
            &#34;favorited&#34;,
            &#34;retweeted&#34;,
            &#34;lang&#34;,
            &#34;entitieshashtags&#34;,
            &#34;entitiessymbols&#34;,
            &#34;entitiesuser_mentions&#34;,
            &#34;entitiesurls&#34;,
            &#34;metadataiso_language_code&#34;,
            &#34;metadataresult_type&#34;,
            &#34;userid&#34;,
            &#34;userid_str&#34;,
            &#34;username&#34;,
            &#34;userscreen_name&#34;,
            &#34;userlocation&#34;,
            &#34;userdescription&#34;,
            &#34;userurl&#34;,
            &#34;userentitiesurlurls&#34;,
            &#34;userentitiesdescriptionurls&#34;,
            &#34;userprotected&#34;,
            &#34;userfollowers_count&#34;,
            &#34;userfriends_count&#34;,
            &#34;userlisted_count&#34;,
            &#34;usercreated_at&#34;,
            &#34;userfavourites_count&#34;,
            &#34;userutc_offset&#34;,
            &#34;usertime_zone&#34;,
            &#34;usergeo_enabled&#34;,
            &#34;userverified&#34;,
            &#34;userstatuses_count&#34;,
            &#34;userlang&#34;,
            &#34;usercontributors_enabled&#34;,
            &#34;useris_translator&#34;,
            &#34;useris_translation_enabled&#34;,
            &#34;userprofile_background_color&#34;,
            &#34;userprofile_background_image_url&#34;,
            &#34;userprofile_background_image_url_https&#34;,
            &#34;userprofile_background_tile&#34;,
            &#34;userprofile_image_url&#34;,
            &#34;userprofile_image_url_https&#34;,
            &#34;userprofile_banner_url&#34;,
            &#34;userprofile_link_color&#34;,
            &#34;userprofile_sidebar_border_color&#34;,
            &#34;userprofile_sidebar_fill_color&#34;,
            &#34;userprofile_text_color&#34;,
            &#34;userprofile_use_background_image&#34;,
            &#34;userhas_extended_profile&#34;,
            &#34;userdefault_profile&#34;,
            &#34;userdefault_profile_image&#34;,
            &#34;userfollowing&#34;,
            &#34;userfollow_request_sent&#34;,
            &#34;usernotifications&#34;,
            &#34;usertranslator_type&#34;,
            &#34;userwithheld_in_countries&#34;,
            &#34;retweeted_statuscreated_at&#34;,
            &#34;retweeted_statusid&#34;,
            &#34;retweeted_statusid_str&#34;,
            &#34;retweeted_statustext&#34;,
            &#34;retweeted_statustruncated&#34;,
            &#34;retweeted_statusentitieshashtags&#34;,
            &#34;retweeted_statusentitiessymbols&#34;,
            &#34;retweeted_statusentitiesuser_mentions&#34;,
            &#34;retweeted_statusentitiesurls&#34;,
            &#34;retweeted_statusmetadataiso_language_code&#34;,
            &#34;retweeted_statusmetadataresult_type&#34;,
            &#34;retweeted_statussource&#34;,
            &#34;retweeted_statusin_reply_to_status_id&#34;,
            &#34;retweeted_statusin_reply_to_status_id_str&#34;,
            &#34;retweeted_statusin_reply_to_user_id&#34;,
            &#34;retweeted_statusin_reply_to_user_id_str&#34;,
            &#34;retweeted_statusin_reply_to_screen_name&#34;,
            &#34;retweeted_statususerid&#34;,
            &#34;retweeted_statususerid_str&#34;,
            &#34;retweeted_statususername&#34;,
            &#34;retweeted_statususerscreen_name&#34;,
            &#34;retweeted_statususerlocation&#34;,
            &#34;retweeted_statususerdescription&#34;,
            &#34;retweeted_statususerurl&#34;,
            &#34;retweeted_statususerentitiesdescriptionurls&#34;,
            &#34;retweeted_statususerprotected&#34;,
            &#34;retweeted_statususerfollowers_count&#34;,
            &#34;retweeted_statususerfriends_count&#34;,
            &#34;retweeted_statususerlisted_count&#34;,
            &#34;retweeted_statususercreated_at&#34;,
            &#34;retweeted_statususerfavourites_count&#34;,
            &#34;retweeted_statususerutc_offset&#34;,
            &#34;retweeted_statususertime_zone&#34;,
            &#34;retweeted_statususergeo_enabled&#34;,
            &#34;retweeted_statususerverified&#34;,
            &#34;retweeted_statususerstatuses_count&#34;,
            &#34;retweeted_statususerlang&#34;,
            &#34;retweeted_statususercontributors_enabled&#34;,
            &#34;retweeted_statususeris_translator&#34;,
            &#34;retweeted_statususeris_translation_enabled&#34;,
            &#34;retweeted_statususerprofile_background_color&#34;,
            &#34;retweeted_statususerprofile_background_image_url&#34;,
            &#34;retweeted_statususerprofile_background_image_url_https&#34;,
            &#34;retweeted_statususerprofile_background_tile&#34;,
            &#34;retweeted_statususerprofile_image_url&#34;,
            &#34;retweeted_statususerprofile_image_url_https&#34;,
            &#34;retweeted_statususerprofile_banner_url&#34;,
            &#34;retweeted_statususerprofile_link_color&#34;,
            &#34;retweeted_statususerprofile_sidebar_border_color&#34;,
            &#34;retweeted_statususerprofile_sidebar_fill_color&#34;,
            &#34;retweeted_statususerprofile_text_color&#34;,
            &#34;retweeted_statususerprofile_use_background_image&#34;,
            &#34;retweeted_statususerhas_extended_profile&#34;,
            &#34;retweeted_statususerdefault_profile&#34;,
            &#34;retweeted_statususerdefault_profile_image&#34;,
            &#34;retweeted_statususerfollowing&#34;,
            &#34;retweeted_statususerfollow_request_sent&#34;,
            &#34;retweeted_statususernotifications&#34;,
            &#34;retweeted_statususertranslator_type&#34;,
            &#34;retweeted_statususerwithheld_in_countries&#34;,
            &#34;retweeted_statusgeo&#34;,
            &#34;retweeted_statuscoordinates&#34;,
            &#34;retweeted_statusplace&#34;,
            &#34;retweeted_statuscontributors&#34;,
            &#34;retweeted_statusis_quote_status&#34;,
            &#34;retweeted_statusretweet_count&#34;,
            &#34;retweeted_statusfavorite_count&#34;,
            &#34;retweeted_statusfavorited&#34;,
            &#34;retweeted_statusretweeted&#34;,
            &#34;retweeted_statuslang&#34;,
            &#34;possibly_sensitive&#34;,
            &#34;entitiesmedia&#34;,
            &#34;extended_entitiesmedia&#34;,
            &#34;retweeted_statusentitiesmedia&#34;,
            &#34;retweeted_statusextended_entitiesmedia&#34;,
            &#34;retweeted_statususerentitiesurlurls&#34;,
            &#34;retweeted_statuspossibly_sensitive&#34;,
            &#34;placeid&#34;,
            &#34;placeurl&#34;,
            &#34;placeplace_type&#34;,
            &#34;placename&#34;,
            &#34;placefull_name&#34;,
            &#34;placecountry_code&#34;,
            &#34;placecountry&#34;,
            &#34;placecontained_within&#34;,
            &#34;placebounding_boxtype&#34;,
            &#34;placebounding_boxcoordinates&#34;,
            &#34;quoted_status_id&#34;,
            &#34;quoted_status_id_str&#34;,
            &#34;quoted_statuscreated_at&#34;,
            &#34;quoted_statusid&#34;,
            &#34;quoted_statusid_str&#34;,
            &#34;quoted_statustext&#34;,
            &#34;quoted_statustruncated&#34;,
            &#34;quoted_statusentitieshashtags&#34;,
            &#34;quoted_statusentitiessymbols&#34;,
            &#34;quoted_statusentitiesuser_mentions&#34;,
            &#34;quoted_statusentitiesurls&#34;,
            &#34;quoted_statusentitiesmedia&#34;,
            &#34;quoted_statusextended_entitiesmedia&#34;,
            &#34;quoted_statusmetadataiso_language_code&#34;,
            &#34;quoted_statusmetadataresult_type&#34;,
            &#34;quoted_statussource&#34;,
            &#34;quoted_statusin_reply_to_status_id&#34;,
            &#34;quoted_statusin_reply_to_status_id_str&#34;,
            &#34;quoted_statusin_reply_to_user_id&#34;,
            &#34;quoted_statusin_reply_to_user_id_str&#34;,
            &#34;quoted_statusin_reply_to_screen_name&#34;,
            &#34;quoted_statususerid&#34;,
            &#34;quoted_statususerid_str&#34;,
            &#34;quoted_statususername&#34;,
            &#34;quoted_statususerscreen_name&#34;,
            &#34;quoted_statususerlocation&#34;,
            &#34;quoted_statususerdescription&#34;,
            &#34;quoted_statususerurl&#34;,
            &#34;quoted_statususerentitiesurlurls&#34;,
            &#34;quoted_statususerentitiesdescriptionurls&#34;,
            &#34;quoted_statususerprotected&#34;,
            &#34;quoted_statususerfollowers_count&#34;,
            &#34;quoted_statususerfriends_count&#34;,
            &#34;quoted_statususerlisted_count&#34;,
            &#34;quoted_statususercreated_at&#34;,
            &#34;quoted_statususerfavourites_count&#34;,
            &#34;quoted_statususerutc_offset&#34;,
            &#34;quoted_statususertime_zone&#34;,
            &#34;quoted_statususergeo_enabled&#34;,
            &#34;quoted_statususerverified&#34;,
            &#34;quoted_statususerstatuses_count&#34;,
            &#34;quoted_statususerlang&#34;,
            &#34;quoted_statususercontributors_enabled&#34;,
            &#34;quoted_statususeris_translator&#34;,
            &#34;quoted_statususeris_translation_enabled&#34;,
            &#34;quoted_statususerprofile_background_color&#34;,
            &#34;quoted_statususerprofile_background_image_url&#34;,
            &#34;quoted_statususerprofile_background_image_url_https&#34;,
            &#34;quoted_statususerprofile_background_tile&#34;,
            &#34;quoted_statususerprofile_image_url&#34;,
            &#34;quoted_statususerprofile_image_url_https&#34;,
            &#34;quoted_statususerprofile_banner_url&#34;,
            &#34;quoted_statususerprofile_link_color&#34;,
            &#34;quoted_statususerprofile_sidebar_border_color&#34;,
            &#34;quoted_statususerprofile_sidebar_fill_color&#34;,
            &#34;quoted_statususerprofile_text_color&#34;,
            &#34;quoted_statususerprofile_use_background_image&#34;,
            &#34;quoted_statususerhas_extended_profile&#34;,
            &#34;quoted_statususerdefault_profile&#34;,
            &#34;quoted_statususerdefault_profile_image&#34;,
            &#34;quoted_statususerfollowing&#34;,
            &#34;quoted_statususerfollow_request_sent&#34;,
            &#34;quoted_statususernotifications&#34;,
            &#34;quoted_statususertranslator_type&#34;,
            &#34;quoted_statususerwithheld_in_countries&#34;,
            &#34;quoted_statusgeo&#34;,
            &#34;quoted_statuscoordinates&#34;,
            &#34;quoted_statusplaceid&#34;,
            &#34;quoted_statusplaceurl&#34;,
            &#34;quoted_statusplaceplace_type&#34;,
            &#34;quoted_statusplacename&#34;,
            &#34;quoted_statusplacefull_name&#34;,
            &#34;quoted_statusplacecountry_code&#34;,
            &#34;quoted_statusplacecountry&#34;,
            &#34;quoted_statusplacecontained_within&#34;,
            &#34;quoted_statusplacebounding_boxtype&#34;,
            &#34;quoted_statusplacebounding_boxcoordinates&#34;,
            &#34;quoted_statuscontributors&#34;,
            &#34;quoted_statusis_quote_status&#34;,
            &#34;quoted_statusretweet_count&#34;,
            &#34;quoted_statusfavorite_count&#34;,
            &#34;quoted_statusfavorited&#34;,
            &#34;quoted_statusretweeted&#34;,
            &#34;quoted_statuspossibly_sensitive&#34;,
            &#34;quoted_statuslang&#34;,
            &#34;retweeted_statusplaceid&#34;,
            &#34;retweeted_statusplaceurl&#34;,
            &#34;retweeted_statusplaceplace_type&#34;,
            &#34;retweeted_statusplacename&#34;,
            &#34;retweeted_statusplacefull_name&#34;,
            &#34;retweeted_statusplacecountry_code&#34;,
            &#34;retweeted_statusplacecountry&#34;,
            &#34;retweeted_statusplacecontained_within&#34;,
            &#34;retweeted_statusplacebounding_boxtype&#34;,
            &#34;retweeted_statusplacebounding_boxcoordinates&#34;,
            &#34;retweeted_statusquoted_status_id&#34;,
            &#34;retweeted_statusquoted_status_id_str&#34;,
            &#34;retweeted_statusquoted_statuscreated_at&#34;,
            &#34;retweeted_statusquoted_statusid&#34;,
            &#34;retweeted_statusquoted_statusid_str&#34;,
            &#34;retweeted_statusquoted_statustext&#34;,
            &#34;retweeted_statusquoted_statustruncated&#34;,
            &#34;retweeted_statusquoted_statusentitieshashtags&#34;,
            &#34;retweeted_statusquoted_statusentitiessymbols&#34;,
            &#34;retweeted_statusquoted_statusentitiesuser_mentions&#34;,
            &#34;retweeted_statusquoted_statusentitiesurls&#34;,
            &#34;retweeted_statusquoted_statusentitiesmedia&#34;,
            &#34;retweeted_statusquoted_statusextended_entitiesmedia&#34;,
            &#34;retweeted_statusquoted_statusmetadataiso_language_code&#34;,
            &#34;retweeted_statusquoted_statusmetadataresult_type&#34;,
            &#34;retweeted_statusquoted_statussource&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_status_id&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_status_id_str&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_user_id&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_user_id_str&#34;,
            &#34;retweeted_statusquoted_statusin_reply_to_screen_name&#34;,
            &#34;retweeted_statusquoted_statususerid&#34;,
            &#34;retweeted_statusquoted_statususerid_str&#34;,
            &#34;retweeted_statusquoted_statususername&#34;,
            &#34;retweeted_statusquoted_statususerscreen_name&#34;,
            &#34;retweeted_statusquoted_statususerlocation&#34;,
            &#34;retweeted_statusquoted_statususerdescription&#34;,
            &#34;retweeted_statusquoted_statususerurl&#34;,
            &#34;retweeted_statusquoted_statususerentitiesurlurls&#34;,
            &#34;retweeted_statusquoted_statususerentitiesdescriptionurls&#34;,
            &#34;retweeted_statusquoted_statususerprotected&#34;,
            &#34;retweeted_statusquoted_statususerfollowers_count&#34;,
            &#34;retweeted_statusquoted_statususerfriends_count&#34;,
            &#34;retweeted_statusquoted_statususerlisted_count&#34;,
            &#34;retweeted_statusquoted_statususercreated_at&#34;,
            &#34;retweeted_statusquoted_statususerfavourites_count&#34;,
            &#34;retweeted_statusquoted_statususerutc_offset&#34;,
            &#34;retweeted_statusquoted_statususertime_zone&#34;,
            &#34;retweeted_statusquoted_statususergeo_enabled&#34;,
            &#34;retweeted_statusquoted_statususerverified&#34;,
            &#34;retweeted_statusquoted_statususerstatuses_count&#34;,
            &#34;retweeted_statusquoted_statususerlang&#34;,
            &#34;retweeted_statusquoted_statususercontributors_enabled&#34;,
            &#34;retweeted_statusquoted_statususeris_translator&#34;,
            &#34;retweeted_statusquoted_statususeris_translation_enabled&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_image_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_image_url_https&#34;,
            &#34;retweeted_statusquoted_statususerprofile_background_tile&#34;,
            &#34;retweeted_statusquoted_statususerprofile_image_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_image_url_https&#34;,
            &#34;retweeted_statusquoted_statususerprofile_banner_url&#34;,
            &#34;retweeted_statusquoted_statususerprofile_link_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_sidebar_border_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_sidebar_fill_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_text_color&#34;,
            &#34;retweeted_statusquoted_statususerprofile_use_background_image&#34;,
            &#34;retweeted_statusquoted_statususerhas_extended_profile&#34;,
            &#34;retweeted_statusquoted_statususerdefault_profile&#34;,
            &#34;retweeted_statusquoted_statususerdefault_profile_image&#34;,
            &#34;retweeted_statusquoted_statususerfollowing&#34;,
            &#34;retweeted_statusquoted_statususerfollow_request_sent&#34;,
            &#34;retweeted_statusquoted_statususernotifications&#34;,
            &#34;retweeted_statusquoted_statususertranslator_type&#34;,
            &#34;retweeted_statusquoted_statususerwithheld_in_countries&#34;,
            &#34;retweeted_statusquoted_statusgeo&#34;,
            &#34;retweeted_statusquoted_statuscoordinates&#34;,
            &#34;retweeted_statusquoted_statusplaceid&#34;,
            &#34;retweeted_statusquoted_statusplaceurl&#34;,
            &#34;retweeted_statusquoted_statusplaceplace_type&#34;,
            &#34;retweeted_statusquoted_statusplacename&#34;,
            &#34;retweeted_statusquoted_statusplacefull_name&#34;,
            &#34;retweeted_statusquoted_statusplacecountry_code&#34;,
            &#34;retweeted_statusquoted_statusplacecountry&#34;,
            &#34;retweeted_statusquoted_statusplacecontained_within&#34;,
            &#34;retweeted_statusquoted_statusplacebounding_boxtype&#34;,
            &#34;retweeted_statusquoted_statusplacebounding_boxcoordinates&#34;,
            &#34;retweeted_statusquoted_statuscontributors&#34;,
            &#34;retweeted_statusquoted_statusis_quote_status&#34;,
            &#34;retweeted_statusquoted_statusretweet_count&#34;,
            &#34;retweeted_statusquoted_statusfavorite_count&#34;,
            &#34;retweeted_statusquoted_statusfavorited&#34;,
            &#34;retweeted_statusquoted_statusretweeted&#34;,
            &#34;retweeted_statusquoted_statuspossibly_sensitive&#34;,
            &#34;retweeted_statusquoted_statuslang&#34;,
            &#34;quoted_statusplace&#34;,
            &#34;geotype&#34;,
            &#34;geocoordinates&#34;,
            &#34;coordinatestype&#34;,
            &#34;coordinatescoordinates&#34;,
        ]
        col_not_in_dd = [col for col in cols_343 if col not in dd.columns.tolist()]
        for col in col_not_in_dd:
            dd[col] = np.nan
        dd = dd[cols_343]  # pylint: disable=C0103

        creat_path_tree(f&#34;data/tweets/q={q_folder}&#34;)
        if os.path.exists(f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;):
            dd.to_csv(
                f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;,
                index=False,
                mode=&#34;a&#34;,
                header=False,
            )
        else:
            dd.to_csv(f&#34;data/tweets/q={q_folder}/{dt}.csv&#34;, index=False)
            # twitter fetch data from most recent to most oldest
            # the first tweet from first page is the most recent, how its what we call last_id
            first_page_df = dd.copy()

        log(f&#34;    page: {i} | tweets: {len(dd)} | columns: {len(dd.columns)}&#34;)

    return first_page_df</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.get_api"><code class="name flex">
<span>def <span class="ident">get_api</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the Twitter API.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task
def get_api():
    &#34;&#34;&#34;
    Get the Twitter API.
    &#34;&#34;&#34;

    # pylint: disable=C0103
    CREDENTIALS = json.loads(decode_env(os.getenv(&#34;TWITTER_CREDENTIALS&#34;)))

    auth = tweepy.OAuthHandler(
        CREDENTIALS[&#34;CONSUMER_KEY&#34;], CREDENTIALS[&#34;CONSUMER_SECRET&#34;]
    )
    auth.set_access_token(
        CREDENTIALS[&#34;ACCESS_TOKEN&#34;], CREDENTIALS[&#34;ACCESS_TOKEN_SECRET&#34;]
    )
    return tweepy.API(auth)</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.get_last_id"><code class="name flex">
<span>def <span class="ident">get_last_id</span></span>(<span>api, q, data_path: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Get last_id from storage table or twitter api.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task(nout=2)
def get_last_id(api, q, data_path: str):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Get last_id from storage table or twitter api.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    pre_path = f&#34;{data_path}/twitter_flamengo/last_id/q={q_folder}&#34;
    if not os.path.exists(f&#34;{pre_path}/{q_folder}.csv&#34;):
        log(f&#34;No last_id table found for {q}, fetch last_id from Twitter API&#34;)
        tweet = api.search_tweets(q=q, count=1)[0]
        last_id = tweet.id
        created_at = tweet.created_at
        time.sleep(5)
    else:
        df = pd.read_csv(f&#34;{pre_path}/{q_folder}.csv&#34;).copy()  # pylint: disable=C0103
        if len(df) &gt; 0:
            log(f&#34;Getting last_id from storage table {q_folder}&#34;)
            last_id = int(df[[&#34;id&#34;]].iloc[-1])
            created_at = df[[&#34;created_at&#34;]].iloc[-1].values[0]
        else:
            log(f&#34;No last_id saved in table for {q}, fetch last_id from Twitter API&#34;)
            tweet = api.search_tweets(q=q, count=1)[0]
            last_id = tweet.id
            created_at = tweet.created_at
            time.sleep(5)
    return last_id, created_at</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.normalize_cols"><code class="name flex">
<span>def <span class="ident">normalize_cols</span></span>(<span>df)</span>
</code></dt>
<dd>
<div class="desc"><p>Normalize columns names.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def normalize_cols(df):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Normalize columns names.
    &#34;&#34;&#34;
    return (
        df.str.normalize(&#34;NFKD&#34;)
        .str.encode(&#34;ascii&#34;, errors=&#34;ignore&#34;)
        .str.decode(&#34;utf-8&#34;)
        .str.replace(&#34;$&#34;, &#34;&#34;)
        .str.replace(&#34;(&#34;, &#34;&#34;)
        .str.replace(&#34;)&#34;, &#34;&#34;)
        .str.replace(&#34;-&#34;, &#34;&#34;)
        .str.replace(&#34; &#34;, &#34;_&#34;)
        .str.lower()
        .str.replace(&#34;.&#34;, &#34;&#34;)
        .str.replace(&#34;/&#34;, &#34;_&#34;)
    )</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.save_last_id"><code class="name flex">
<span>def <span class="ident">save_last_id</span></span>(<span>df, q)</span>
</code></dt>
<dd>
<div class="desc"><p>Save the last tweet ID.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task
def save_last_id(df, q):  # pylint: disable=C0103
    &#34;&#34;&#34;
    Save the last tweet ID.
    &#34;&#34;&#34;
    q_folder = q.replace(&#34; &#34;, &#34;_&#34;).replace(&#34;-&#34;, &#34;_&#34;)
    pre_path = f&#34;data/staging/twitter_flamengo/last_id/q={q_folder}&#34;
    creat_path_tree(pre_path)

    if not os.path.exists(f&#34;{pre_path}/{q_folder}.csv&#34;):
        pd.DataFrame({&#34;q&#34;: [], &#34;id&#34;: [], &#34;created_at&#34;: []}).to_csv(
            f&#34;{pre_path}/{q_folder}.csv&#34;, index=False
        )

    if df is None:
        log(&#34;   No new tweets found&#34;)
    else:
        # twitter fetch data from most recent to most oldest
        # last_id must to be the most recent id
        df = df[[&#34;id&#34;, &#34;created_at&#34;]].iloc[[0]].copy()
        df.to_csv(f&#34;{pre_path}/{q_folder}.csv&#34;, index=False, mode=&#34;a&#34;, header=False)
    return &#34;data/staging&#34;</code></pre>
</details>
</dd>
<dt id="pipelines.rj_escritorio.tweets_flamengo.tasks.upload_to_storage"><code class="name flex">
<span>def <span class="ident">upload_to_storage</span></span>(<span>path: str)</span>
</code></dt>
<dd>
<div class="desc"><p>upload data to storage</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@task
def upload_to_storage(path: str):
    &#34;&#34;&#34;
    upload data to storage
    &#34;&#34;&#34;
    tb_last_id = bd.Table(dataset_id=&#34;twitter_flamengo&#34;, table_id=&#34;last_id&#34;)
    tb_last_id.append(f&#34;{path}/twitter_flamengo/last_id&#34;)
    if os.path.isdir(f&#34;{path}/&#34;):
        shutil.rmtree(f&#34;{path}/&#34;)

    tb_tweet = bd.Table(dataset_id=&#34;twitter_flamengo&#34;, table_id=&#34;tweets&#34;)
    tb_tweet.append(
        &#34;data/tweets&#34;,
    )
    if os.path.isdir(&#34;data/tweets/&#34;):
        shutil.rmtree(&#34;data/tweets/&#34;)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo" href="index.html">pipelines.rj_escritorio.tweets_flamengo</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.creat_path_tree" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.creat_path_tree">creat_path_tree</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.decode_env" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.decode_env">decode_env</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_last_id" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_last_id">fetch_last_id</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_tweets" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.fetch_tweets">fetch_tweets</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.get_api" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.get_api">get_api</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.get_last_id" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.get_last_id">get_last_id</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.normalize_cols" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.normalize_cols">normalize_cols</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.save_last_id" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.save_last_id">save_last_id</a></code></li>
<li><code><a title="pipelines.rj_escritorio.tweets_flamengo.tasks.upload_to_storage" href="#pipelines.rj_escritorio.tweets_flamengo.tasks.upload_to_storage">upload_to_storage</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>